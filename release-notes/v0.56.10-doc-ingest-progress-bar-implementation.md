# Document Ingestion Progress Bar Implementation Guide

## Overview
This document details the implementation of progress bars for document ingestion in Langroid v0.56.10, providing visual feedback during large document processing operations.

## Architecture

### 1. Base Class Enhancement (`langroid/vector_store/base.py`)

#### Progress Callback Signature
```python
def add_documents(
    self,
    documents: Sequence[Document],
    progress_callback: Optional[Callable[[str, int, int], None]] = None,
) -> None:
```

The callback receives three parameters:
- `stage`: String indicating the current stage ("embedding" or "storing")
- `current`: Current progress count
- `total`: Total number of items to process

#### Default Progress Bar Factory
```python
def _create_default_progress_callback(self) -> Tuple[Progress, Callable[[str, int, int], None]]:
```
Creates a rich progress bar with:
- Spinner animation
- Stage description
- Progress bar visualization
- Current/total count display

### 2. Vector Store Implementations

Each vector store implementation was updated to support progress tracking:

#### QdrantDB (`langroid/vector_store/qdrantdb.py`)
- Progress tracking for embedding generation (all at once)
- Progress tracking for batch uploads (per batch)
- Automatic progress bar for >10 documents

#### ChromaDB (`langroid/vector_store/chromadb.py`)
- Single-phase progress (ChromaDB generates embeddings internally)
- Progress shown for both embedding and storing phases simultaneously

#### LanceDB (`langroid/vector_store/lancedb.py`)
- Progress integrated into the batch generator pattern
- Updates progress as each batch is yielded

#### PostgresDB (`langroid/vector_store/postgres.py`)
- Similar to QdrantDB with embedding and batch storage phases
- Progress updates aligned with transaction commits

### 3. DocChatAgent Integration (`langroid/agent/special/doc_chat_agent.py`)

The `ingest_docs` method was enhanced to create and manage progress bars:

```python
with Progress(...) as progress:
    def progress_callback(stage: str, current: int, total: int) -> None:
        # Update progress tasks
    
    callback = progress_callback if len(docs) > 10 else None
    self.vecdb.add_documents(docs, progress_callback=callback)
```

## Implementation Patterns

### 1. Hybrid Approach
- Automatic progress bars when no callback provided
- Custom callback support for advanced use cases
- Threshold-based display (>10 documents)

### 2. Two-Phase Progress
Most implementations show two distinct phases:
1. **Embedding Generation**: Computing vector embeddings for documents
2. **Document Storage**: Storing documents and embeddings in the vector database

### 3. Batch-Aware Progress
Progress updates align with batch processing:
```python
for batch_idx, i in enumerate(range(0, len(ids), batch_size)):
    if progress_callback:
        progress_callback("storing", i, len(ids))
    # Process batch
```

### 4. Context Manager Pattern
Progress bars use context managers for proper cleanup:
```python
if progress_callback is None and len(documents) > 10:
    progress_context, progress_callback = self._create_default_progress_callback()
    progress_context.__enter__()
# ... processing ...
if progress_context:
    progress_context.__exit__(None, None, None)
```

## Usage Examples

### Basic Usage (Automatic Progress)
```python
agent = DocChatAgent(config)
# Progress bars appear automatically for >10 documents
agent.ingest_docs(large_document_list)
```

### Custom Progress Callback
```python
def custom_progress(stage: str, current: int, total: int):
    print(f"{stage}: {current}/{total} ({current/total*100:.1f}%)")

vecdb.add_documents(documents, progress_callback=custom_progress)
```

### Disabling Progress
```python
# For 10 or fewer documents, no progress shown by default
# Or explicitly pass None
vecdb.add_documents(documents, progress_callback=None)
```

## Design Decisions

### 1. Optional Parameter
- Maintains backward compatibility
- No changes required to existing code
- Progressive enhancement approach

### 2. Threshold-Based Display
- Avoids visual clutter for small operations
- 10 document threshold chosen as reasonable default
- Configurable via callback parameter

### 3. Rich Library Integration
- Leverages rich.progress for modern terminal UI
- Consistent with existing Langroid UI patterns
- Provides professional appearance

### 4. Stage-Based Progress
- Separates embedding and storage phases
- Helps users understand where time is spent
- Allows optimization of bottlenecks

## Future Enhancements

### Potential Improvements
1. **Configurable Thresholds**: Make the 10-document threshold configurable
2. **Time Estimates**: Add ETA based on processing rate
3. **Nested Progress**: Support for chunking progress within document progress
4. **Async Progress**: Full async/await support for progress updates
5. **Memory Usage**: Display memory consumption during ingestion

### Extension Points
- Custom progress renderers via the callback system
- Integration with logging frameworks
- Web UI progress reporting
- Metrics collection for performance analysis

## Testing Considerations

### Unit Testing
- Mock progress callbacks to verify correct invocation
- Test threshold behavior (â‰¤10 vs >10 documents)
- Verify progress math (current/total calculations)

### Integration Testing
- Test with actual vector stores
- Verify progress accuracy with various batch sizes
- Test interruption/cancellation behavior

### Performance Testing
- Ensure progress updates don't significantly impact performance
- Test with very large document sets (10k+ documents)
- Measure overhead of progress tracking

## Migration Guide

### For Library Users
No changes required. Progress bars appear automatically for large ingestions.

### For Custom Vector Store Implementations
1. Update `add_documents` signature to include `progress_callback` parameter
2. Add progress calls at appropriate points:
   ```python
   if progress_callback:
       progress_callback("embedding", 0, len(documents))
   # ... generate embeddings ...
   if progress_callback:
       progress_callback("embedding", len(documents), len(documents))
   ```
3. Consider using `_create_default_progress_callback()` for automatic progress

## Troubleshooting

### Common Issues
1. **No Progress Shown**: Check document count (must be >10 for automatic progress)
2. **Progress Jumps**: Ensure batch boundaries align with progress updates
3. **Terminal Compatibility**: Rich requires terminal with ANSI support

### Debug Mode
Set environment variable for detailed progress logging:
```bash
export LANGROID_PROGRESS_DEBUG=1
```